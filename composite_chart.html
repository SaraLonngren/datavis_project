<!DOCTYPE html>
<html>
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Composite Chart</title>
    <!-- Custom styles for this template -->
  <link rel="stylesheet" href="css/dc.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/crossfilter.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="js/dc.min.js"></script>
</head>
<body>
  <main role="main" class="container">
    <div class='row'>
    <div id="chart">
    </div>
    </div>
  </main>
    <script type="text/javascript">
      let compositeChart = dc.compositeChart('#chart');
      
      d3.csv("data/line_chart_data.csv").then(function(data) {
        let parseDate = d3.timeParse("%d/%m/%Y");
        data.forEach(function(d) {
          d.month = parseDate(d.month)
          d.month = d.month.setFullYear(2018);
        });

        var ndx = crossfilter(data);
        dateDim = ndx.dimension(function(d) {return d3.timeMonth(d.month);});

        composeGraphs = []
        yearsAndColors = [
          {'year':'2018', 'color':'#3366cc'},
          {'year':'2017', 'color':'#dc3912'},
          {'year':'2016', 'color':'#ff9900'},
          {'year':'2015', 'color':'#109618'},
          {'year':'2014', 'color':'#990099'},
          {'year':'2013', 'color':'#0099c6'},
          {'year':'2012', 'color':'#dd4477'},
          {'year':'2011', 'color':'#000000'}
        ];

        yearsAndColors.forEach(function(item) {
          dataFiltered = data.filter(function(d) { if(d.year == item.year){ return d; }})
          factsFiltered = crossfilter(dataFiltered);
          dateDimFiltered = factsFiltered.dimension(function(d) {return d3.timeMonth(d.month);});
          dataDimGroup = dateDimFiltered.group().reduceSum(function(d) {return d.amount;});

          composeGraphs.push(
            dc.lineChart(compositeChart)
              .group(dataDimGroup, item.year)
              .ordinalColors([item.color])
          );
        });

        let xScale = d3.scaleTime()
                      .domain([dateDim.bottom(1)[0].month, dateDim.top(1)[0].month])

        compositeChart.width(800)
                     .height(400)
                     .margins({top: 50, right: 50, bottom: 50, left: 50})
                     .dimension(dateDim)
                     .x(xScale)
                     .y(d3.scaleLinear().domain([20000, 50000]))
                     .round(d3.timeMonth.round)
                     .xUnits(d3.timeMonths)
                     .xAxisLabel('Meses do ano')
                     .yAxisLabel('Quantidade de ocorrÃªncias')
                     .mouseZoomable(true)
                     .renderHorizontalGridLines(true)
                     .legend(dc.legend().x(300).y(20).itemHeight(13).itemWidth(50).gap(5).horizontal(1))
                     .brushOn(false)
                     .title(function(d) { return 'Quantidade: ' + d.value; })
                     .compose(composeGraphs);

        compositeChart.render();
      });
    </script>
</body>
</html>